name: Helm OCI Chart Build
description: Publish Helm charts to OCI-based (Docker) registries
author: Samhammer AG
branding:
  color: blue
  icon: tag
inputs:
  registry:
    required: true
    description: OCI registry
  registry_user:
    required: true
    description: OCI registry username
  registry_password:
    required: true
    description: OCI registry password
  registry_path:
    required: true
    description: Chart registry path
  chart_version:
    required: false
    description: Chart version (only optional, when defined in Chart.yaml)
  app_version:
    required: true
    description: App version (will be tagged and updated in Chart.yaml)
  chart_folder:
    required: true
    description: Chart folder
  chart_annotations:
    required: false
    description: Chart annotations that should be added (e.g. company 'samhammer ag' author 'alwin schiffman')
outputs:
  image:
    value: ${{ steps.output.outputs.image }}
    description: Chart image (Default '{registry}/{registry_path}:{chart_version}')
runs:
  using: composite
  steps:
    - name: Helm | Login
      shell: bash
      run: echo ${{ inputs.registry_password }} | helm registry login -u ${{ inputs.registry_user }} --password-stdin ${{ inputs.registry }}
      env:
        HELM_EXPERIMENTAL_OCI: '1'

    - name: Helm | Chart | Annotations
      shell: bash
      run: |
        if [ "${{ inputs.chart_annotations }}" ]
        then
            echo "${{ inputs.chart_annotations }}" | tr ',' '\n' | xargs -n2 -r bash -c 'yq write -i '"${{ inputs.chart_folder }}/Chart.yaml"' "annotations.$1" "$2"' argv0
            echo "Cart annotations:"
            yq read "${{ inputs.chart_folder }}/Chart.yaml" annotations
        fi

    - name: Helm | Chart | Version
      shell: bash
      run: |
        if [ "${{ inputs.app_version }}" ]
        then
            yq write -i "${{ inputs.chart_folder }}/Chart.yaml" appVersion "${{ inputs.app_version }}"
        else
          echo "::error::inputs.app_version is required"; exit 1
        fi

        if [ "${{ inputs.chart_version }}" ]
        then
            yq write -i "${{ inputs.chart_folder }}/Chart.yaml" version "${{ inputs.chart_version }}"
        fi

        echo "App version: $(yq read '${{ inputs.chart_folder }}/Chart.yaml' appVersion)"
        echo "Cart version: $(yq read '${{ inputs.chart_folder }}/Chart.yaml' version)"

    - name: Helm | Chart | Save
      shell: bash
      run: |
        helm chart save ${{ inputs.chart_folder }} ${{ inputs.registry }}/${{ inputs.registry_path }}:${{ inputs.app_version }}
      env:
        HELM_EXPERIMENTAL_OCI: '1'

    - name: Helm | Chart | Push
      shell: bash
      run: helm chart push ${{ inputs.registry }}/${{ inputs.registry_path }}:${{ inputs.app_version }}
      env:
        HELM_EXPERIMENTAL_OCI: '1'

    - name: Helm | Logout
      shell: bash
      run: helm registry logout ${{ inputs.registry }}
      env:
        HELM_EXPERIMENTAL_OCI: '1'

    - name: Helm | Output
      id: output
      shell: bash
      run: echo "image=${{ inputs.registry }}/${{ inputs.registry_path }}:${{ inputs.app_version }}">> $GITHUB_OUTPUT
